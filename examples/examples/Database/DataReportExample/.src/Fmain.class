' Gambas class file

arrtable[2] As String

hFile As File
flname As String

Public Sub show_data()
  'create the header's view
  With GridView1
    .rows.count = 0
    .columns.count = 2
    .columns[0].text = "User's Id"
    .columns[1].text = "User's Name"
  End With
  Mglobal.fill_view(GridView1, "select * from user order by id")
End

Public Sub clear()
  textbox1.text = ""
  textbox2.text = ""
End

Public Sub Form_Open()
Dim i As Float
  flname = User.home & "/gbDataReportExample.htm"

  Me.center
  show_data()
End

Public Sub Form_Close()
  'delete the report when the form closed
  If Exist(flname) Then Kill flname
End

Public Sub ginput_KeyPress()
Dim a As Integer

  With mglobal
  Select Case Last.tag
    Case 1 'textbox ID
      a = .chk(textbox1, Key.code, "num")
      Select Case a
        Case 1
          Me.close
        Case 2
          Stop Event
      End Select

      If Key.code = Key.enter Or Key.code = Key.return Then
        .rs = .db.exec("select name from user where id='" & textbox1.text & "'")
        If .rs.count <> 0 Then
          textbox2.text = .rs!name
        Else
          textbox2.text = ""
        End If
        textbox2.setfocus
      End If

    Case 2 'textbox Name
      a = .chk(textbox2, Key.code)
      Select Case a
        Case 1
          Me.close
        Case 2
          Stop Event
      End Select

      If Key.code = Key.enter Or Key.code = Key.return Then
        textbox1.setfocus
        .rs = .db.exec("select * from user where id='" & textbox1.text & "'")
        If .rs.count = 0 Then
          'there's no record, then we'll do insert query here!
          .rs = .db.exec("insert into user values('" & textbox1.text & "', '" & textbox2.text & "')")
        Else
          'there's a record, then asked the user if (s)he wants to update the record or not ?
          If Message.question("Record Already Exist!\n Wanna to Update it ?", .btnok, .btnno) = 1 Then
            .rs = .db.exec("update user set name='" & textbox2.text & "' where id='" & textbox1.text & "'")
          Else
            'if the user don't want to update, then asked if (s)he want to delete that record or not ?
            If Message.question("You want to Delete it ?", .btnok, .btnno) = 1 Then
              .rs = .db.exec("delete from user where id='" & textbox1.text & "'")
            Endif
          Endif
        Endif
        clear()
        show_data()
      End If

  End Select
  End With

Catch
  Message.Error(Error.Text)
End

Public Sub GridView1_Data(Row As Integer, Column As Integer)
  'the array's field name's
  arrtable[0] = "id"
  arrtable[1] = "name"
  With Mglobal
    .rs1.MoveTo(Row)
    GridView1.data.Text = Str(.rs1[arrtable[Column]])
  End With
End

Public Sub GridView1_Click()
  textbox1.text = GridView1[GridView1.row, 0].text
  textbox2.text = GridView1[GridView1.row, 1].text
  textbox1.setfocus
Catch
End

Public Sub GridView1_KeyRelease()
  Select Case Key.code
    Case Key.Enter, Key.Return
      GridView1_click()

    Case Key.Escape
      Me.close
  End Select
End

Public Sub gbtn_Click()
  Select Case Last.tag
    Case 1 'print to screen
      printit(False)

    Case 2 'print to printer
      printit(True)

    Case 3 'about
      Fabout.ShowModal
  End Select
End

Public Sub gbtn_KeyPress()
  If Key.code = Key.escape Then Me.close
End

Public Sub header(prn As Boolean)
  Print #hFile, "<html>"
  Print #hFile, "<head><title>gbDataReportExample - by Rizky Tahara Shita</title></head>"
  Print #hFile, "<body topmargin='0' leftmargin='0'"
    If prn = True Then Print #hFile, " onload='window.print()'"
  Print #hFile, ">"
  Print #hFile, "<table border='1' width='500' cellpadding='4' cellspacing='0'>"
  Print #hFile, "  <tr>"
  Print #hFile, "    <td colspan='2' align='center'>"
  Print #hFile, "      <h3>User's Lists</h3>"
  Print #hFile, "    </td>"
  Print #hFile, "  </tr>"
  Print #hFile, "  <tr><td colspan='2'>&nbsp;</td></tr>"
  Print #hFile, "  <tr>"
  Print #hFile, "    <td width='15%' align='center'>User's Id</td>"
  Print #hFile, "    <td align='center'>User's Name</td>"
  Print #hFile, "  </tr>"
End

Public Sub content(p1 As String, p2 As String)
  Print #hFile, "  <tr>"
  Print #hFile, "    <td>" & p1 & "</td>"
  Print #hFile, "    <td>" & p2 & "</td>"
  Print #hFile, "  </tr>"
End

Public Sub footer()
  Print #hFile, "</table>"
  Print #hFile, "</body>"
  Print #hFile, "</html>"
End

Public Sub printit(prn As Boolean)
Dim i As Float

  With mglobal
    .rs = .db.exec("select * from user order by id")
    If .rs.count <> 0 Then
      If Exist(flname) Then Kill flname
      hFile = Open flname For Write Create
        'print headers here
        header(prn)
        i = 0
        While i < .rs.count
          'print all data here
          content(CStr(.rs!id), CStr(.rs!name))
          i = i + 1
          .rs.MoveNext
        Wend
        'print footer here
        footer
      Close #hFile
      'show the report !
      Fpreview.SetPath(flname)
      Fpreview.ShowModal
    Endif
  End With
End
