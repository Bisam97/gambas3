' Gambas class file

Static Private $sPath As String

Private btnNew As CCoolButton
Private btnOpen As CCoolButton
Private btnRecent As CCoolButton
Private btnExample As CCoolButton
Private btnQuit As CCoolButton

Private $iRecent As Integer
Private $aExample As String[]
Private $bExample As Boolean
Private $hFirst As ProjectItem
'Private $hPicture As Picture

Private Const LIST_NONE As Integer = 0
Private Const LIST_RECENT As Integer = 1
Private Const LIST_EXAMPLE As Integer = 2

Private Const POS_BUTTON As Integer = 0
Private HEIGHT_BUTTON As Integer = Desktop.Scale * 8

Private $hWelcome As CWelcome
Private $iSort As Integer = CRecentFile.SORT_BY_DATE

Static Public Function Run() As String

  'DIM hForm AS Form

  $sPath = ""
  'hForm = NEW FWelcome
  FWelcome.ShowModal()
  Return $sPath

End

Public Sub Form_Open()

  Dim W As Integer
  Dim sFont As String
  Dim hImage As Image
  Dim hLogo As SvgImage
  Dim hCtrl As CCoolButton

  sFont = "Bold"
  W = panButton.ClientW

  btnNew = New CCoolButton(panButton, 0, POS_BUTTON, W, HEIGHT_BUTTON, ("New project..."), "icon:/large/new", sFont) As "btnNew"
  btnOpen = New CCoolButton(panButton, 0, POS_BUTTON + HEIGHT_BUTTON, W, HEIGHT_BUTTON, ("Open project..."), "icon:/large/open", sFont) As "btnOpen"
  btnRecent = New CCoolButton(panButton, 0, POS_BUTTON + HEIGHT_BUTTON * 2, W, HEIGHT_BUTTON, ("Recent projects"), "icon:/large/open-recent", sFont) As "btnRecent"
  btnExample = New CCoolButton(panButton, 0, POS_BUTTON + HEIGHT_BUTTON * 3, W, HEIGHT_BUTTON, ("Examples"), "icon:/large/help", sFont) As "btnExample"
  btnQuit = New CCoolButton(panButton, 0, POS_BUTTON + HEIGHT_BUTTON * 4, W, HEIGHT_BUTTON, ("Quit"), "icon:/large/quit", sFont) As "btnQuit"

  For Each hCtrl In [btnNew, btnOpen, btnRecent, btnExample, btnQuit]
    hCtrl.Foreground = Color.White
    hCtrl.Highlight = &H3398C3& ' &HDF6B00&
  Next

  ' Fill recent list

  $iSort = Settings["/FWelcome/SortRecent", CRecentFile.SORT_BY_DATE]
  UpdateMenuSort
  FillRecent

  If CRecentFile.All.Count Then
    Toggle(LIST_RECENT)
  Else
    Toggle(LIST_EXAMPLE)
  Endif

  $hWelcome = New CWelcome(dwgWelcome)

  Settings.Read(Me)
  
End


Public Sub cvwRecent_Click()

  $sPath = CRecentFile.All[Val(Last.Key)].Path
  Me.Close

End


' PUBLIC SUB timMessage_Timer()
' 
'   IF System.RightToLeft THEN
'     INC lblMessage.X
'     IF lblMessage.X >= panMessage.W THEN
'       lblMessage.X = - lblMessage.Width
'     ENDIF
'   ELSE
'     DEC lblMessage.X
'     IF lblMessage.X <= (- lblMessage.Width) THEN
'       lblMessage.X = panMessage.Width
'     ENDIF
'   ENDIF
' 
' END


Public Sub btnNew_Click()

  $sPath = FCreateProject.Run()
  If $sPath Then Me.Close

End


Public Sub btnOpen_Click()

  $sPath = FOpenProject.Run()
  If $sPath Then Me.Close

End


Public Sub btnRecent_Click()

  Toggle(LIST_RECENT)

End


Public Sub btnExample_Click()

  Toggle(LIST_EXAMPLE)

End



Public Sub btnQuit_Click()

  $sPath = ""
  Me.Close(True)

End

Private Sub Toggle(iState As Integer)

  'IF iState = $iRecent THEN
  '  $iRecent = LIST_NONE
  'ELSE
    $iRecent = iState
  'ENDIF

  'ME.Border = Window.Resizable

  If $iRecent Then
    'btnQuit.Move(8, 216 + cvwRecent.H + 8)
    'cvwRecent.Move(360 - cvwRecent.W, 216)
    panList.Raise
    lstRecent.Visible = $iRecent = LIST_RECENT
    lstExample.Visible = $iRecent = LIST_EXAMPLE
    panList.Visible = True
    If $iRecent = LIST_RECENT Then
      lblList.Text = ("Recent projects")
      panFilter.Show
      txtFilter.SetFocus
    Else
      lblList.Text = ("Examples")
      panFilter.Hide
    Endif
    lblList2.Text = lblList.Text
    panList_Arrange
  Else
    panList.Visible = False
  Endif

  If $iRecent = LIST_EXAMPLE Then 
    FillExample
  Endif
  
End

Public Sub Form_KeyPress()

  If Key.Code = Key.Escape Then
    btnQuit_Click
  Endif

End



Public Sub Form_Close()

  Settings.Write(Me)
  Settings["/FWelcome/SortRecent"] = $iSort

End

' PUBLIC SUB dwgRound_Draw()
' 
'   Draw.FillColor = LAST.Foreground
'   Draw.LineStyle = Line.None
'   Draw.FillStyle = Fill.Solid
'   Draw.RoundRect(0, 0, LAST.W, LAST.H)
' 
' END

Public Sub dwgExample_Draw()
  
  Dim hDrawingArea As DrawingArea = Last
  
  'Draw.FillRect(Draw.Clip.X, Draw.Clip.Y, Draw.Clip.Width, Draw.Clip.Height, Int(Rnd(0, &H1000000)))
  
  Draw.Font = hDrawingArea.Font
  Draw.Text(hDrawingArea.Tag, 4, 0, Draw.W - 16, Draw.H - 4, Align.BottomNormal)
  Draw.Line(4, Draw.H - 4, Draw.W - 9, Draw.H - 4)
  
End

' Public Sub dwgExample_Draw()
'   
'   Dim hDrawingArea As DrawingArea = Last
'   
'   With hDrawingArea
'     Draw.Font = .Font
' 
'     'Draw.Foreground = .Foreground
'     'Draw.Line(0, .H / 2 - 2, .W - 1, .H / 2 - 2)
'     'Draw.Picture($hPicture, 0, 0, .W, .H)
'  
'     'Draw.FillStyle = Fill.Solid
'     'Draw.LineStyle = Line.None
'     'Draw.FillColor = .Background
'     'Draw.Rect(8, 0, Draw.TextWidth(.Tag) + 8, .H)
'     
'     Draw.Text(.Tag, 8, 0, .W - 8, .H - 2, Align.Normal)
'   
'   End With
'   
' End

Private Sub GetTitle(hProjectInfo As CProjectInfo) As String
  
  With hProjectInfo
    Return "<b>" & .Name & "</b> " & .Version & "<br><font size=\"-1\" color=\"#404040\">" & .Title & "</font>"
  End With
  
End

Public Sub chkSortRecent_Click()

  FillRecent  

End

Public Sub lblWebSite_MouseDown()

  Last.Foreground = Color.LightBackground

End

Public Sub lblWebSite_MouseUp()
  
  Last.Foreground = Color.TextBackground
  If Mouse.X >= 0 And If Mouse.Y >= 0 And If Mouse.X < Last.W And If Mouse.Y < Last.H Then
    Wait
    Desktop.Open(Last.Text)
  Endif
  
End

Public Sub Form_Resize()

  'panBackground.H = lblMessage.Y + lblMessage.H + Desktop.Scale * 2

End


' Public Sub timMadeIn_Timer()
' 
'   Dim hBrush As PaintBrush
'   Dim hImage As Image
' 
'   $eAng += $eIncAng
'   If $eAng >= 360 Then $eAng -= 360
' 
'   'If Me.Minimized Then Return
'   
'   hImage = $hLogo.Copy()
'   If $eIncAng < 0 Then hImage = hImage.Mirror(True, False)
' 
'   Paint.Begin(hImage)
'   Paint.Translate(Paint.W / 2, Paint.H / 2)
'   Paint.Rotate(Rad($eAng))
'   Paint.Translate(- Paint.W / 2, - Paint.H / 2)
'   hBrush = Paint.Image($hMadeIn)
'   hBrush.Scale(Paint.W / $hMadeIn.W, Paint.H / $hMadeIn.H)
'   Paint.Brush = hBrush
'   Paint.Rectangle(0, 0, Paint.W, Paint.H)
'   Paint.Fill
'   Paint.End
'   
'   $hDraw = hImage.Picture
'   
'   dwgLogo.Refresh
'   
' End
' 
' Public Sub dwgLogo_MouseUp()
' 
'   $eIncAng = - $eIncAng
' 
' End
' 
' Public Sub dwgLogo_Draw()
' 
'   If $hDraw Then Draw.Picture($hDraw, 0, 0, Draw.W, Draw.W)
' 
' End

Public Sub lblWebSite_Enter()

  Last.Foreground = Color.LightBackground

End

Public Sub lblWebSite_Leave()

  Last.Foreground = Color.Default

End


Public Sub lstRecent_Menu()

  mnuSort.Popup

End

Private Sub UpdateMenuSort()
  
  Dim hMenu As Menu
  
  For Each hMenu In mnuSort.Children
    hMenu.Checked = hMenu.Tag = $iSort
  Next
  
End


Public Sub mnuSort_Click()
  
  $iSort = Last.Tag
  lstRecent.Clear
  FillRecent
  UpdateMenuSort
  
End

Public Sub panList_Arrange()

  lblList2.Move(lblList.X + 1, lblList.Y + 1, lblList.W, lblList.H)
  lblList2.Lower

End

Public Sub txtFilter_Click()

  txtFilter.Clear

End

Public Sub txtFilter_Change()

  FilterRecent

End

Private Sub FilterRecent()

  Dim sFilter As String = Trim(txtFilter.Text)
  Dim hCtrl, hLast As Control
  Dim hFirst, hProjectItem As ProjectItem
  
  lstRecent.Lock
  
  If Not sFilter Then
    sFilter = "*"
  Else
    sFilter = "*" & String.LCase(sFilter) & "*"
  Endif
  
  For Each hCtrl In lstRecent.Children
    
    If hCtrl Is ProjectItem Then
      hProjectItem = hCtrl
      hProjectItem.Visible = hProjectItem.Match(sFilter)
      If hProjectItem.Visible Then 
        If Not hFirst Then hFirst = hProjectItem
      Endif
    Endif
    
  Next
  
  For Each hCtrl In lstRecent.Children
    
    If hCtrl Is DrawingArea Then
      If hLast Then hLast.Hide
      hLast = hCtrl
    Else If hCtrl Is ProjectItem And If hCtrl.Visible Then
      If hLast Then hLast.Show
      hLast = Null
    Endif
    
  Next
  
  If hLast Then hLast.Hide
  
  $hFirst = hFirst
  
  'lstRecent.Select(hFirst)
  lstRecent.Unlock
  
End

Private Sub FillRecent()
  
  Dim hProjectItem As ProjectItem
  Dim hFirst As ProjectItem
  Dim aRecent As CRecentFile[]
  Dim hRecent As CRecentFile
  'Dim bHighlight As Boolean
  Dim fTime As Float
  Dim sTitle As String
  Dim sLastTitle As String
  Dim Y As Integer
  Dim hDrawingArea As DrawingArea
  
  If lstRecent.Count And If Not CRecentFile.OutOfDate Then Return

  Inc Application.Busy

  'panRecent.Hide
  lstRecent.Lock
  Object.Lock(lstRecent)
  lstRecent.Clear

  aRecent = CRecentFile.Get($iSort)

  For Each hRecent In aRecent
    
    sTitle = hRecent.GetTitle($iSort)
    
    If sTitle <> sLastTitle Then
      hDrawingArea = New DrawingArea(lstRecent) As "dwgExample"
      With hDrawingArea
        .Enabled = False
        .Tag = sTitle 
        .Font = Font["Bold"]
        .H = .Font.Height + If(sLastTitle, 16, 8)
        .Foreground = Color.SelectedBackground
        Y += .H
      End With
      sLastTitle = sTitle
    Endif
    
    hProjectItem = New ProjectItem(lstRecent) As "ProjectItem"
    hProjectItem.Y = Y
    Y += hProjectItem.H
    'If bHighlight Then hProjectItem.Background = Color.LightBackground
    'bHighlight = Not bHighlight
    If Not hFirst Then hFirst = hProjectItem
    hProjectItem.Path = hRecent.Path
    
  Next
  
  ' Workaround a scrollview bug that does not show the scrollbars.
  lstRecent.Unlock 
  Object.Unlock(lstRecent)
  'panRecent.Show
  
  Dec Application.Busy
  
End

Private Sub FillExample()

  Dim sExample As String
  Dim sDir As String
  Dim sLastDir As String
  Dim hDrawingArea As DrawingArea
  Dim hProjectItem As ProjectItem
  Dim hLabel As Label
  'Dim bHighlight As Boolean
  
  If lstExample.Children.Count Then Return

  Inc Application.Busy
  lstExample.Lock
  Object.Lock(lstExample)

  For Each sExample In Project.GetExamples()
  
    sDir = File.Dir(sExample)
    If sDir <> sLastDir Then
      hDrawingArea = New DrawingArea(lstExample) As "dwgExample"
      With hDrawingArea
        .Enabled = False
        .Tag = Project.ExampleTitle[sDir]
        .Font = Font["Bold"]
        .H = .Font.Height + If(sLastDir, 16, 8)
        .Foreground = Color.SelectedBackground
      End With
      'bHighlight = False
      sLastDir = sDir
    Endif
    
    hProjectItem = New ProjectItem(lstExample) As "ProjectItem"
    'If bHighlight Then hProjectItem.Background = Color.LightBackground
    'bHighlight = Not bHighlight
    hProjectItem.Path = Project.EXAMPLES_DIR &/ sExample
  
  Next

  'lstExample.Show ' Workaround a scrollview bug that does not show the scrollbars.
  lstExample.Unlock
  Object.Unlock(lstExample)

  Dec Application.Busy

End

Public Sub ProjectItem_Click()

  $sPath = Last.Path
  Me.Close

End

Public Sub txtFilter_Activate()

  If Not $hFirst Then Return
  $sPath = $hFirst.Path
  Me.Close

End
