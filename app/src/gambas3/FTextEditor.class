' Gambas class file

Public Name As String
Public Path As String
Public Editor As Editor

Property Read ReadOnly As Boolean

Static Private $aExt As String[] = ["htm", "html", "xml", "svg", "css"]

Private Const STYLE_HTML As Integer = 1
Private Const STYLE_CSS As Integer = 2

Private $bModify As Boolean
Private $iStyle As Integer

Private $iViewMode As Integer
Private VIEWMODE_NORMAL As Integer = 0 
Private VIEWMODE_HORIZONTAL As Integer = 1
Private VIEWMODE_VERTICAL As Integer = 2

Private $hEditor1 As Editor
Private $hEditor2 As Editor

Public Sub _new(sPath As String)

  Path = sPath
  Name = File.Name(Path)
  Editor = edtEditor

End

Public Sub Form_Open()
  
  Dim sExt As String = LCase(File.Ext(Name))
  
  If $aExt.Find(sExt) >= 0 Then
    With edtEditor
      .Clear
      .Highlight = Highlight.Custom
      .Flags[Editor.HighlightCurrent] = True
    End With     

    Select Case sExt
      Case "css"
        $iStyle = STYLE_CSS
      Case Else 
        $iStyle = STYLE_HTML
    End Select 
  Endif

  ReadConfig

  Project.InitMove(Me)

  SetReadOnly
  Reload

  $bModify = False
  edtEditor.SetFocus

  DrawTitle
  
End

Public Sub Form_Resize()
  Dim iToolbarOffset As Integer
  
  'If we add the ability to hide the toolbar then uncomment this code 
  'IF $bToolbar THEN
  '  panToolBar.Move(0, 0, ME.CLientW)
  '  iToolbarOffset = panToolBar.H
  'ELSE
    iToolbarOffset = 0
  'ENDIF
  
  Select Case $iViewMode
  Case 0
    edtEditor.Move(0, iToolbarOffset, Me.ClientW, Me.ClientH - iToolbarOffset)
  Case 1
    splHorizontal.Move(0, iToolbarOffset, Me.ClientW, Me.ClientH - iToolbarOffset)
  Case 2
    splVertical.Move(0, iToolbarOffset, Me.ClientW, Me.ClientH - iToolbarOffset)
  End Select 

End

Public Sub ReadConfig()

  ReadConfigEditor(edtEditor)
  If $hEditor1 Then ReadConfigEditor($hEditor1)
  If $hEditor2 Then ReadConfigEditor($hEditor2)

End

Private Sub ReadConfigEditor(hEditor As Editor)

  hEditor.Font = Font[Settings["/Editor/Font", Project.DEFAULT_FONT]]

  MTheme.InitEditor(hEditor)

  hEditor.Flags[hEditor.ShowModifiedLines] = Settings["/Editor/ShowChange", True]
  hEditor.Flags[hEditor.ShowLineNumbers] = Settings["/Editor/ShowLineNumbers", False]
  hEditor.Flags[hEditor.ShowCurrentLine] = Settings["/Editor/ShowCurrent", True]
  
End

Public Function Save() As Boolean

  'Project.Config.WriteString("/Window" &/ Name &/ "Pos",
  '  CStr(ME.X) & "," & CStr(ME.Y) & "," & CStr(ME.Width) & "," & CStr(ME.Height))

  If NOT $bModify Then Return

  Save.Begin(Path)

  File.Save(Path, Editor.Text)
  Editor.Reset
  $bModify = False
  DrawTitle

  Save.End()

Catch

  Return Save.Error()

End

Private Sub DrawTitle()

  Project.DrawTitle(Me)

End

Public Sub Modify(Optional bReset As Boolean)

  If Project.ReadOnly Then Return
  If $bModify <> bReset Then Return

  $bModify = NOT bReset
  DrawTitle
  If $bModify Then Inc Project.TimeStamp

End


Public Function IsModified() As Boolean

  Return $bModify

End


Public Sub Editors_Change()

  Modify

End


Public Sub Editors_Cursor()

  'PRINT edtEditor.Line; edtEditor.Column
  'lblCursor.Text = CStr(edtEditor.Line + 1) & " : " & CStr(edtEditor.Column + 1)
  DrawInfo

End

Public Sub Editors_KeyPress()
  
  If Key.Code = Key.Escape Then 
    Action["find"].Value = False
  Endif
  
  If Key.Code = Key.Insert Then

    If Key.Shift Then
      If NOT Editor.ReadOnly Then
        Editor.Paste
      Endif 
    Else If Key.Control Then
      Editor.Copy
    Endif 
    
  Else If Key.Code = Key.Delete Then

    If Key.Shift Then
      If NOT Editor.ReadOnly Then
        Editor.Cut
      Endif 
    Endif 
  Endif 

End



'PUBLIC SUB Form_KeyPress(Ascii AS String, Code AS Integer, State AS Integer)
'
'  IF Code = Asc("S") AND State = Mouse.Control THEN
'    ME.Save
'  ENDIF
'
'END



Public Sub Form_GotFocus()
  
  Editor.SetFocus
  
End

Public Sub Goto(iLine As Integer, Optional iColumn As Integer = -1)

  'DEC iLine
  If iColumn < 0 Then iColumn = Editor.Column
  Editor.Goto(iLine, iColumn, True)

End


Public Sub GotoCenter(iLine As Integer, Optional iColumn As Integer = -1)

  Goto(iLine, iColumn)

End


Public Sub Editors_Menu()

  mnuEditor.Popup

End

Public Sub Editors_GotFocus()
  Editor = Last 
End

Public Sub mnuSave_Click()

  Save

End


' PUBLIC SUB mnuFind_Click()
'
'   DIM sSel AS String
'   DIM iPos AS Integer
'
'   sSel = Left$(Trim(edtEditor.Selection.Text), 64)
'   iPos = Instr(sSel, gb.NewLine)
'   IF iPos THEN sSel = Left$(sSel, iPos - 1)
'
'   Project.FindForm.Find(sSel)
'
' END
'
'
' PUBLIC SUB mnuFindNext_Click()
'
'   Project.FindForm.FindNext
'
' END
'
'
' PUBLIC SUB mnuFindPrevious_Click()
'
'   Project.FindForm.FindPrevious
'
' END


Public Sub Rename(sNewName As String, sNewPath As String)

  Name = sNewName
  Path = sNewPath 'File.Dir(Path) &/ sNewName & "." & File.Ext(Path)
  DrawTitle

End


Public Sub mnuCut_Click()

  Editor.Cut

End

Public Sub mnuCopy_Click()

  Editor.Copy

End

Public Sub mnuPaste_Click()

  Editor.Paste

End

Public Sub mnuUndo_Click()

  Editor.Undo

End

Public Sub mnuRedo_Click()

  Editor.Redo

End


Public Sub mnuGotoLine_Click()

  Dim iLine As Integer

  iLine = FGotoLine.Run(Editor.Line + 1)
  If iLine <= 0 Then Return
  GotoCenter(iLine - 1)

End


' PUBLIC SUB mnuWordWrap_Click()
'
'   edtEditor.Wrap = NOT edtEditor.Wrap
'   mnuWordWrap.Checked = edtEditor.Wrap
'
' END


Public Sub mnuSelectAll_Click()

  Editor.SelectAll()

End


Private Sub SetReadOnly()

  edtEditor.ReadOnly = Project.ReadOnly OR Project.Running OR Stat(Path).Type = gb.Link

  If $hEditor1 Then $hEditor1.ReadOnly = edtEditor.ReadOnly
  If $hEditor2 Then $hEditor2.ReadOnly = edtEditor.ReadOnly

End

Public Sub OnProjectDebug()

  SetReadOnly

End


Public Sub mnuFind_Click()

  FFind.Find

End

Public Sub mnuReplace_Click()

  FFind.Find(True)

End


Public Sub Editors_Highlight()

  Dim iState As Integer
  Dim iNextState As Integer
  Dim iInd As Integer
  Dim J As Integer
  Dim sText As String
  Dim sCar As String
  Dim iPos As Integer
  Dim bMarkup As Boolean
  Dim bQuote As Boolean
  Dim bLimit As Boolean
  Dim iTag As Integer

  iState = Highlight.State
  iTag = Highlight.Tag
  sText = Highlight.Text

  'PRINT "Highlight:";; iState;; iTag;; sText

  Select Case $iStyle
  
    Case STYLE_HTML

      bMarkup = iState = Highlight.Keyword
    
      For iInd = 1 To String.Len(sText)
    
        iNextState = iState
        sCar = String.Mid$(sText, iInd, 1)
    
        If bMarkup Then
    
          If bQuote Then
            If sCar = Chr$(34) Then 
              bQuote = False
              iNextState = Highlight.Operator
            Endif
          Else If sCar = ">" Then
            bMarkup = False
            iState = Highlight.Keyword
            iNextState = Highlight.Normal
          Else If sCar = " " Then
            iNextState = Highlight.Operator
          Else If sCar = "=" Then
            iNextState = Highlight.String
          Else If sCar = Chr$(34) Then 
            bQuote = True
          Endif
    
        Else
    
          Select Case iState
            Case Highlight.Normal
              If sCar = "<" Then
                If Mid$(sText, iInd, 4) = "<!--" Then
                  iState = Highlight.Comment
                  iNextState = Highlight.Comment
                Else If Mid$(sText, iInd, 9) = "<![CDATA[" Then
                  iState = Highlight.Symbol
                  iNextState = Highlight.Symbol
                Else
                  iState = Highlight.Keyword
                  iNextState = Highlight.Keyword
                  bMarkup = True
                  If Mid$(sText, iInd, 5) = "<body" Then bLimit = True
                Endif
              Else If sCar = "&" Then
                iPos = String.InStr(sText, ";", iInd)
                If iPos = 0 OR iPos = iInd + 1 Then
                  iState = Highlight.Error
                Else
                  For J = iInd + 1 To iPos - 1
                    sCar = String.Mid$(sText, J, 1)
                    If IsLetter(sCar) Then Continue
                    If IsDigit(sCar) Then Continue
                    If InStr("_#", sCar) Then Continue
                    Break
                  Next
                  If J = iPos Then
                    Highlight.Add(Highlight.Number, iPos - iInd + 1)
                    iInd = iPos
                    Continue
                  Else
                    iState = Highlight.Error
                  Endif
                Endif
              Endif
            Case Highlight.Comment
              If sCar = ">" AND If iInd > 2 AND If String.Mid$(sText, iInd - 2, 2) = "--" Then
                iNextState = Highlight.Normal
              Endif
            Case Highlight.Symbol
              If sCar = ">" AND If iInd > 2 AND If String.Mid$(sText, iInd - 2, 2) = "]]" Then
                iNextState = Highlight.Normal
              Endif
          End Select
    
        Endif
    
        Highlight.Add(iState)
        iState = iNextState
    
      Next
    
      If iNextState <> Highlight.Comment AND If iNextState <> Highlight.Symbol Then
        If bMarkup Then 
          iNextState = Highlight.Keyword
        Else 
          iNextState = Highlight.Normal
        Endif
      Endif
      
    Case STYLE_CSS
    
      For iInd = 1 To String.Len(sText)
    
        iNextState = iState
        sCar = String.Mid$(sText, iInd, 1)

        Select Case iState
        
          Case Highlight.Normal, Highlight.String
            If sCar = "." OR If sCar = "#" Then 
              iState = Highlight.String
              iNextState = iState
            Else If sCar = " " Then 
              iState = Highlight.Normal
              iNextState = iState
            Else If sCar = "{" Then 
              iState = Highlight.Keyword
              iNextState = iState
              iTag = Highlight.Keyword
            Else If sCar = "/" Then 
              If Mid$(sText, iInd, 2) = "/*" Then 
                iState = Highlight.Comment
                iNextState = iState
              Endif
            Endif
            
          Case Highlight.Keyword, Highlight.Number
            If sCar = ":" Then 
              iNextState = Highlight.Number
            Else If sCar = ";" Then 
              iState = Highlight.Keyword
              iNextState = iState
            Else If sCar = "}" Then 
              iNextState = Highlight.Normal
              iTag = 0
            Else If sCar = "/" Then 
              If Mid$(sText, iInd, 2) = "/*" Then 
                iState = Highlight.Comment
                iNextState = iState
              Endif
            Endif
                        
          Case Highlight.Comment
            If sCar = "/" AND If iInd > 1 AND If String.Mid$(sText, iInd - 1, 1) = "*" Then
              iNextState = IIf(iTag, iTag, Highlight.Normal)
            Endif
            
        End Select
        
        Highlight.Add(iState)
        iState = iNextState
    
      Next
    
  End Select 

  Highlight.State = iNextState
  Highlight.Tag = iTag
  Highlight.ShowLimit = bLimit

End

Public Sub Form_Activate()

  mnuEditor.Enabled = True

End

Public Sub Form_Deactivate()

  mnuEditor.Enabled = False

End

Private Function ReadOnly_Read() As Boolean

  Return edtEditor.ReadOnly  

End

Private Sub DrawInfo()
  
  lblEditor.Text = CStr(Editor.Line + 1) & ":" & CStr(Editor.Column + 1)
  
End

Public Sub Reload()

  edtEditor.Text = File.Load(Path)
  Editor.SetFocus
  Modify(True)

End

Public Sub mnuReload_Click()

  If IsModified() Then
    If Message.Warning(("The file has been modified.\n\nAll your changes will be lost."), ("Reload"), ("Cancel")) <> 1 Then Return
  Endif

  Reload

End

Public Sub GetState() As String
  
  Return CStr(Editor.Line) & "." & CStr(Editor.Column)
  
End

Public Sub SetState(sState As String)
  
  Dim aState As String[] = Split(sState, ".")
  
  Editor.Goto(CInt(aState[0]), CInt(aState[1]))
  
End

Private Sub InitEditor(hEditor As Editor)
  
  With hEditor
    .View = edtEditor
    .Highlight = edtEditor.Highlight
    .Flags[Editor.HighlightCurrent] = True
    .ReadOnly = edtEditor.ReadOnly
    .TabSize = edtEditor.TabSize
  End With 
  ReadConfigEditor(hEditor)
  
End

Private Sub SetViewMode(iViewMode As Integer)
  
  If $iViewMode = iViewMode Then Return 
  $iViewMode = iViewMode

  If $iViewMode <> VIEWMODE_NORMAL AND If NOT $hEditor1 Then 
    $hEditor1 = New Editor(Me) As "Editors"
    InitEditor($hEditor1)
    $hEditor2 = New Editor(Me) As "Editors"
    InitEditor($hEditor2)
  Endif

  Select Case $iViewMode
  
    Case VIEWMODE_NORMAL
      edtEditor.Show
      splHorizontal.Hide
      splVertical.Hide
      Editor = edtEditor  
      
    Case VIEWMODE_HORIZONTAL
      $hEditor1.Reparent(splHorizontal)
      $hEditor2.Reparent(splHorizontal)
      edtEditor.Hide
      splHorizontal.Show
      splVertical.Hide
      Editor = $hEditor1
  
    Case VIEWMODE_VERTICAL
      $hEditor1.Reparent(splVertical)
      $hEditor2.Reparent(splVertical)
      edtEditor.Hide
      splHorizontal.Hide
      splVertical.Show
      Editor = $hEditor1
  
  End Select   
  
  Editor.SetFocus
  Form_Resize
  
End

Public Sub mnuNoSplit_Click()
  
  SetViewMode(VIEWMODE_NORMAL)

End

Public Sub mnuHorizontalSplit_Click()

  SetViewMode(VIEWMODE_HORIZONTAL)

End

Public Sub mnuVerticalSplit_Click()

  SetViewMode(VIEWMODE_VERTICAL)

End

