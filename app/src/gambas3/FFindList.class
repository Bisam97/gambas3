' Gambas class file

PRIVATE $aFound AS NEW Object[]
PRIVATE $hFont AS Font
PRIVATE $eAngle AS Float

PUBLIC SUB ClearFound()

  tvwFind.Rows.Count = 0
  $aFound.Clear
  
END

PUBLIC SUB AddFound(sName AS String, iLine AS Integer, iCol AS Integer, iLen AS Integer, sText AS String)
  
  $aFound.Add([sName, iLine + 1, iCol, sText, iLen, FALSE])
  IF $aFound.Count > 1 THEN 
    IF $aFound[$aFound.Max][0] = $aFound[$aFound.Max - 1][0] THEN
      $aFound[$aFound.Max][5] = $aFound[$aFound.Max - 1][5]
    ELSE
      $aFound[$aFound.Max][5] = NOT $aFound[$aFound.Max - 1][5]
    ENDIF
  ENDIF
  tvwFind.Rows.Count = $aFound.Count
  
END

' PUBLIC SUB SelectFound(sName AS String, iLine AS Integer, iCol AS Integer, iLen AS Integer)
'   
'   DIM sKey AS String
'   
'   sKey = FindKey(sName)
'   IF NOT sKey THEN RETURN 
'   
'   sKey = KEY_FIND & sKey & "@" & Format(iLine, "000000") & "." & Format(iCol, "00000") & "." & iLen
'   TRY ProjectTree[sKey].Selected = TRUE
'   
' END

PUBLIC SUB _new()

  WITH tvwFind
    .Columns.Count = 4  
    .Columns[0].Width = Desktop.Scale * 16
    .Columns[0].Text = ("Class")
    .Columns[1].Width = Desktop.Scale * 8
    .Columns[1].Text = ("Line")
    .Columns[2].Width = Desktop.Scale * 8
    .Columns[2].Text = ("Column")
    .Columns[3].Text = ("Text")    
  END WITH
  
  ReadConfig

END

PUBLIC SUB Form_Open()

  Settings.Read(ME)
  MoveMag

END

PUBLIC SUB tvwFind_Data(Row AS Integer, Column AS Integer)

  WITH tvwFind.Data
    
    IF Column = 3 THEN .Font = $hFont 
    
    .Text = $aFound[Row][Column]

    IF Row THEN
      IF Column = 0 THEN 
        IF $aFound[Row - 1][0] = .Text THEN 
          .Text = ""
        ENDIF
      ELSE IF Column = 1 THEN
        IF $aFound[Row - 1][0] = $aFound[Row][0] AND $aFound[Row - 1][1] = $aFound[Row][1] THEN 
          .Text = "-"
        ENDIF
      ENDIF
    ENDIF 
    
    .Background = If($aFound[Row][5], Color.LightBackground, Color.TextBackground)
    
  END WITH

END

PUBLIC SUB tvwFind_Select()

  DIM aFind AS Variant[]
  DIM iLine AS Integer
  DIM iCol AS Integer
  DIM iLen AS Integer 
  DIM hEdit AS Editor
  DIM sPath AS String

  IF timSearch.Enabled THEN RETURN
  IF $aFound.Count = 0 THEN RETURN
  
  aFind = $aFound[tvwFind.Row]
  
  sPath = Project.FindPath(aFind[0])
  IF NOT sPath THEN RETURN
  
  Project.OpenFile(sPath)

  hEdit = Project.Files[sPath].Editor
  iLine = aFind[1] - 1
  iCol = aFind[2] - 1
  iLen = aFind[4]
  hEdit.Goto(iLine, iCol, TRUE)
  hEdit.Select(iLine, iCol, iLine, iCol + iLen)
  
  'Project.ProjectTree[sSave].Selected = TRUE

END

PUBLIC SUB Form_Close()

  Settings.Write(ME)  

END

PUBLIC SUB ReadConfig()
  
  tvwFind.Font.Grade = If(Settings["/UseSmallFont", FALSE], -1, 0)
  $hFont = Font[Settings["/Editor/Font", Project.DEFAULT_FONT]]
  tvwFind.Refresh

END

' PUBLIC SUB panSearch_Arrange()
' 
'   btnCancel.Move(panSearch.Width - btnCancel.Width - Desktop.Scale, Desktop.Scale)
' 
' END

PRIVATE SUB MoveMag()
  
  picSearch.Move(16 + Cos($eAngle) * 8, 16 + Sin($eAngle) * 8 + btnCancel.Y + btnCancel.H + Desktop.Scale)
  
END


PUBLIC SUB timSearch_Timer()

  $eAngle += 0.4
  MoveMag

END

PUBLIC SUB Start()
  
  FMain.Enabled = FALSE
  ME.Enabled = TRUE
  ClearFound
  btnCancel.Text = ("Cancel")
  timSearch.Start
  
END

PUBLIC SUB Stop()
  
  timSearch.Stop
  btnCancel.Text = ("Close")
  FMain.Enabled = TRUE
  
END

PUBLIC SUB btnCancel_Click()

  IF timSearch.Enabled THEN
    FFind.Cancel
  ELSE 
    ME.Close
  ENDIF

END
