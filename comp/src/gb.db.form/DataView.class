' Gambas class file

Export
Inherits UserControl

Public Const _Properties As String = "*,Mode{Select.None;Single;Multi}=None,Header{GridView.None;Horizontal;Vertical;Both}=Both,Grid,Highlight=True,Columns"
Public Const _DrawWith As String = "GridView"

Event Activate

Property Mode As Integer 
Property Header As Integer
Property Grid As Boolean
Property Highlight As Boolean

'PROPERTY Connection AS Connection
'PROPERTY Table AS String
'PROPERTY Filter AS String
Property Columns As String[]
Property Read Current As Variant[]
Property Read Count As Integer
Property Read Index As Integer
Property Read GridView As GridView

'PRIVATE $hConn AS Connection
Private $hCtrl As GridView
'PRIVATE $sTable AS String
'PRIVATE $sFilter AS String
Private $hTable As DataTable
Private $aColumns As String[]
Private $bCreate As Boolean
Private $bRefreshColumn As Boolean
Private $bNoActivate As Boolean
Private $iHighlight As Integer
Private $bHighlight As Boolean

Public Sub _new()
  
  $hCtrl = New GridView(Me) As "GridView"
  $hCtrl.Header = GridView.Both
  '''$hCtrl.AutoResize = TRUE
  '''$hCtrl.Resizable = FALSE
  $hCtrl.Grid = False
  Create()
  Refresh
  
  $bHighlight = True
  $iHighlight = Color.LightBackground
  
End

Private Sub RefreshColumns()
  
  Dim iInd As Integer
  Dim sTable As String
  
  If Common.CheckDB() Then Return
  If Not $bRefreshColumn Then Return
  
  $bRefreshColumn = False
  
  sTable = $hTable.Name
  
  If Not $aColumns Or If $aColumns.Count = 0 Then
    $aColumns = DataConnection.GetFields(sTable)
  Endif
  
  'Object.Lock($hCtrl)
  $bNoActivate = True
  $hCtrl.Columns.Count = $aColumns.Count
  For iInd = 0 To $aColumns.Max
    With DataConnection[sTable, $aColumns[iInd]]
      'Debug .Name;; $hCtrl.Columns[iInd].Width;; .GetWidth($hCtrl)
      $hCtrl.Columns[iInd].Text = .Name
      $hCtrl.Columns[iInd].Width = .GetWidth($hCtrl)
      'Debug "--> "; $hCtrl.Columns[iInd].Width
    End With
  Next
  $bNoActivate = False
  'Object.Unlock($hCtrl)
  
  If $bCreate Then Create()
  
End


Private Sub Load()
  
  Dim hSrc As DataSource
  
  If Common.CheckDB() Then Return
  
  'TRY DB.Open

  'IF NOT $sTable THEN
    hSrc = Common.GetSource(Me)
    If hSrc Then
      $hTable = hSrc._GetTable()
    Endif
  'ELSE
  '  $hTable = NEW DataTable($sTable, $sFilter)
  'ENDIF

  If Not $hTable Then
    $hCtrl.Rows.Count = 0
    Return
  Endif
    
  RefreshColumns
  'Object.Lock($hCtrl)
  $bNoActivate = True
  $hCtrl.Rows.Count = $hTable.Count
  $bNoActivate = False
  'Object.Unlock($hCtrl)
  
  $hCtrl.Refresh

  If hSrc.Index < 0 Then 
    $bCreate = True
    $hCtrl.Rows.UnSelect
  Else
    $hCtrl.Row = hSrc.Index
    $hCtrl.Rows[$hCtrl.Row].Selected = True
  Endif

End


Public Sub Refresh()
  
  Load
  
End



' PRIVATE FUNCTION Table_Read() AS String
'   
'   RETURN $sTable
'   
' END
' 
' PRIVATE SUB Table_Write(sTable AS String)
' 
'   IF $sTable = sTable THEN RETURN  
'   $sTable = sTable
'   Load
'   
' END
' 
' PRIVATE FUNCTION Filter_Read() AS String
'   
'   RETURN $sFilter
'   
' END
' 
' PRIVATE SUB Filter_Write(sFilter AS String)
'   
'   IF $sFilter = sFilter THEN RETURN
'   $sFilter = sFilter
'   Load
'   
' END

Private Function Columns_Read() As String[]
  
  Return $aColumns.Copy()
  
End

Private Sub Columns_Write(aCol As String[])
  
  If Not aCol Then
    $aColumns = Null
  Else
    $aColumns = aCol.Copy()
  Endif

  $bRefreshColumn = True  
  RefreshColumns
  
End

Public Sub GridView_Data(Row As Integer, Column As Integer)
  
  Dim rData As Result
  Dim vVal As Variant
  
  rData = $hTable[Row]
  If Not rData Then Return
  If Not rData.Available Then Return
  
  If $aColumns Then
    vVal = rData[$aColumns[Column]]
  Else
    vVal = rData[Column]
  Endif
  
  If IsBoolean(vVal) Then 
    $hCtrl.Data.Text = If(vVal, ("True"), ("False"))
  Else
    $hCtrl.Data.Text = Str(vVal)
  Endif
  
  If $bHighlight And If Row And 1 Then $hCtrl.Data.Background = $iHighlight
  
End

' PUBLIC SUB GridView_Click()
' 
'   GridView_Change
'     
' END


Public Sub GridView_Change()

  If $bNoActivate Then Return

  $bCreate = False
  Raise Activate
  
End


Private Function Mode_Read() As Integer
  
  Return $hCtrl.Mode
  
End

Private Sub Mode_Write(iMode As Integer)
  
  $hCtrl.Mode = iMode
  
End

Private Function Header_Read() As Integer
  
  Return $hCtrl.Header
  
End

Private Sub Header_Write(iHeader As Integer)
  
  $hCtrl.Header = iHeader
  
End

' PRIVATE FUNCTION Connection_Read() AS Connection
' 
'   IF $hConn <> DB.Current THEN RETURN $hConn
'   
' END
' 
' PRIVATE SUB Connection_Write(hConn AS Connection)
'   
'   IF NOT hConn THEN hConn = DB.Current
'   
'   $hConn = hConn
'   Load
'   
' END
' 
Private Function Current_Read() As Variant[]
  
  Return $hTable.GetKeys($hCtrl.Row)
  
End

Public Sub MoveFirst()

  Try $hCtrl.Row = 0
  $hCtrl.Rows[$hCtrl.Row].Selected = True
  $bCreate = False
  
End

Public Sub MoveLast()
  
  $hCtrl.Row = $hCtrl.Rows.Count - 1
  $hCtrl.Rows[$hCtrl.Row].Selected = True
  $bCreate = False
  
End

Public Sub MoveNext()
  
  If $bCreate Then
    MoveFirst
    Return
  Endif
  If $hCtrl.Row >= ($hCtrl.Rows.Count - 1) Then Return
  If $hCtrl.Row < 0 Then Return
  Inc $hCtrl.Row
  $hCtrl.Rows[$hCtrl.Row].Selected = True
  
End

Public Sub MovePrevious()
  
  If $bCreate Then
    MoveFirst
    Return
  Endif
  If $hCtrl.Row <= 0 Then Return
  Dec $hCtrl.Row
  $hCtrl.Rows[$hCtrl.Row].Selected = True
  
End

Public Sub MoveTo(Index As Integer)
  
  If Index = $hCtrl.Row Then Return
  $hCtrl.Row = Index
  $hCtrl.Rows[$hCtrl.Row].Selected = True
  
End


Public Sub Create()
  
  $bCreate = True
  $hCtrl.Rows.UnSelect
  
End


Private Function Count_Read() As Integer
  
  Return $hCtrl.Rows.Count
  
End

Private Function Index_Read() As Integer

  If $bCreate Then
    Return -1
  Else  
    Return $hCtrl.Row
  Endif
  
End


Public Function Remove() As Boolean
  
  Create()  
  
End

Private Function GridView_Read() As GridView
  
  Return $hCtrl
  
End

Public Sub GridView_ColumnClick(Column As Integer)
  
  Dim hSrc As DataSource
  
  hSrc = Common.GetSource(Me)
  If Not hSrc Then Return
  
  If hSrc.Sort <> $aColumns[Column] Then
    hSrc.Sort = $aColumns[Column]
  Else
    hSrc.Sort = ""
  Endif
  
  $hCtrl.Refresh

End


Private Function Grid_Read() As Boolean

  Return $hCtrl.Grid

End

Private Sub Grid_Write(Value As Boolean)

  $hCtrl.Grid = Value

End

Private Function Highlight_Read() As Boolean

  Return $bHighlight

End

Private Sub Highlight_Write(Value As Boolean)

  $bHighlight = Value

End
