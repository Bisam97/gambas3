' Gambas class file
Static Private $hreport As Report
Private $fScale As Float = 1
Private $iPage As Integer = 1
Private $hPrint As Report
'Private hPrinter As New Printer
Static Public Function Run(hReport As Report)
  Dim hFPreview As FPreview
  $hreport = hReport
  
  hFpreview = New FPreview
  hFpreview.Show
  
End


Public Sub _New()
  
  Me.Center
  
  
End


Public Sub ToolButton1_Click()

  Me.Close

End

Public Sub DrawingArea1_Draw()
  Debug $fScale
  'Paint.Scale($fScale, $fScale)
  '$hreport.Layout
  $hReport.Scale = $fScale
  $hReport.Paint($iPage)
  SpinBox1.MaxValue = Max(5, $hReport.Count)
End

Public Sub Form_Open()

  If $hreport = Null Then Me.Close
  
  'Report.Debug = True
  
  ComboBox1.List = ["A3", "A4", "A5", "B5", "Executive", "Legal", "Letter", "Custom"]
  ComboBox1.Index = 1
  btnAdjust.Value = True
  'Resize
  Printer1.OutputFile = User.Home &/ "output.pdf"
  
End

Public Sub Slider1_Change()
  
  If Not btnAdjust.tag Then btnAdjust.Value = False
  ResizeMe
  
End


Private Sub ResizeMe()
  Dim iWidth, iHeight As Integer
  Dim fratio As Float
  
  
  iWidth = Printer1.PaperWidth * Desktop.Resolution / 25.4
  iHeight = Printer1.PaperHeight * Desktop.Resolution / 25.4
  
  If btnAdjust.Value Then
    
    If Printer1.PaperWidth > Printer1.PaperHeight Then
      $fScale = (ScrollView1.ClientW - 20) / iWidth
    Else
      $fScale = (ScrollView1.ClientH - 20) / iHeight
    Endif
    
  Else
    $fScale = Slider1.Value / 100
  Endif
  DrawingArea1.Resize(iWidth * $fScale, iHeight * $fScale)
  DrawingArea1.Refresh

End


Public Sub ComboBox1_Click()
   
  Printer1.Paper = Object.GetProperty(Printer, ComboBox1.Text)
  
  If ComboBox1.Text = "Custom" Then 
    Frame3.Enabled = True
  Else 
    Frame3.Enabled = False
    txtWidth.Text = Int(Printer1.PaperWidth)
    txtHeight.Text = Int(Printer1.PaperHeight)
  Endif
  $hreport.Refresh()
  'Slider1_Change
End

Public Sub ComboBox2_Click()

  Printer1.Orientation = ComboBox2.Index
  ComboBox1_Click
  ResizeMe

End

Public Sub txtWidth_Change()

  Printer1.PaperWidth = txtWidth.Text

  ResizeMe
  
  Catch
  

End

Public Sub txtHeight_Change()

    Printer1.PaperHeight = txtHeight.Text
  ResizeMe

End

Public Sub ToolButton2_Click()

  Try Dec Slider1.Value

End

Public Sub ToolButton3_Click()

  Try Inc Slider1.Value

End

Public Sub Button1_Click()
  
  If Printer1.Configure() Then Return
  'Me.Enabled = False
  Printer1.Print()
  'Me.Enabled = True
  
End

Public Sub Printer1_Draw()

  $hPrint.Paint($iPage)

End

Public Sub Printer1_Begin()

  $hPrint = Object.New(Object.Type($hReport))
  $hPrint.Layout
  Printer1.Count = 1 '$hreport.Count

End

Public Sub Printer1_End()
  
  $hPrint = Null
  
End





Public Sub Form_Resize()

  ResizeMe

End

Public Sub btnAdjust_Click()
  btnAdjust.Tag = 1
  ResizeMe
  Slider1.Value = $fScale * 100
  btnAdjust.Tag = Null
End

Public Sub btnZNorm_Click()
  btnAdjust.Value = False
  Slider1.Value = 100

End

Public Sub SpinBox1_Change()

  $iPage = Last.Value 
  DrawingArea1.Refresh

End
