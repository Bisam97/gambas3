' Gambas class file

Inherits UserControl
Export

Public Const _Properties As String = "*,Border=True,Mode{Select.*},Dir,ShowDetailed,ShowHidden,ShowDirectory"
Public Const _DefaultEvent As String = "Click"

Event {Select}
Event Click
Event Activate
Event Menu
Event Icon(Path As String)

Property {Dir} As String
Property ShowHidden As Boolean
Property ShowDirectory As Boolean
Property Current As String
Property Font As Font
Property Mode As Integer
Property ShowDetailed As Boolean
Property Read Selection As String[]
Property Filter As String[]
Property Icon As Picture
Property Border As Boolean
Property Settings As Variant[]
Property Read Count As Integer

Static Private $aImgExt As String[] = ["png", "jpeg", "jpg", "gif", "xpm"]
Static Private $cExt As New Collection(gb.IgnoreCase)

Private $sDir As String
Private $bShowHidden As Boolean
Private $bShowDir As Boolean
Private $hIconView As IconView
Private $hColumnView As ColumnView
Private $iSort As Integer
Private $bAsc As Boolean = True
Private $aFilter As String[]
Private $hPict As Picture
Private $hRefresh As Timer
Private $bRefreshTriggered As Boolean

Static Public Sub _init()
  
  $cExt["html"] = "html"
  $cExt["htm"] = "html"
  $cExt["css"] = "html"
  $cExt["tar"] = "archive"
  $cExt["gz"] = "archive"
  $cExt["tgz"] = "archive"
  $cExt["bz2"] = "archive"
  $cExt["z"] = "archive"
  $cExt["zip"] = "archive"
  $cExt["txt"] = "text"
  $cExt["mp3"] = "audio"
  $cExt["ogg"] = "audio"
  $cExt["wav"] = "audio"
  $cExt["mpg"] = "video"
  $cExt["mpeg"] = "video"
  $cExt["avi"] = "video"
  $cExt["wmv"] = "video"
  $cExt["mov"] = "video"

End


Public Sub _new()

  With $hIconView = New IconView(Me) As "View"
    .Sorted = True
    .GridWidth = 24
  End With

  With $hColumnView = New ColumnView(Me) As "View"
    .Columns.Count = 3
    .Columns[0].Text = ("Name")
    .Columns[1].Text = ("Size")
    .Columns[1].Alignment = Align.Right
    .Columns[2].Text = ("Last modified")
    .Columns[2].Alignment = Align.Right
    '.Columns[0].Width = 64
    '.Columns[1].Width = 64
    '.Columns[2].Width = 96
    .Visible = False
    .Sorted = True
    .Resizable = True
  End With

  $hRefresh = New Timer As "Refresh"

  RefreshViewLater
  RefreshGrid

End

Private Function CheckFilter(sFile As String) As Boolean

  Dim sFilter As String

  For Each sFilter In $aFilter
    If sFile Like sFilter Then Return
  Next

  Return True

End

Private Sub GetIcon(sPath As String, iSize As Integer) As picture
  
  Dim hImage As Image
  Dim sIcon As String
  
  $hPict = Null
  Raise Icon(sPath)
  If $hPict Then Return $hPict

  Try sIcon = $cExt[File.Ext(sPath)]
  If sIcon Then Return Picture["icon:/" & CStr(iSize) &/ sIcon]

  If $aImgExt.Find(File.Ext(sPath)) < 0 Then Return
  If Stat(sPath).Size > 65536 Then Return Picture["icon:/" & iSize & "/image"]
  
  hImage = Image.Load(sPath)
  If Not (hImage.Width = iSize And hImage.Height = iSize) Then 
    If hImage.Width > hImage.Height Then 
      hImage = hImage.Stretch(iSize, (iSize * hImage.Height) \ hImage.Width)
    Else
      hImage = hImage.Stretch((iSize * hImage.Width) \ hImage.Height, iSize)
    Endif
  Endif
  
  Return hImage.Picture
  
Catch
  
  Return Picture["icon:/" & iSize & "/image"]
  
End


Private Sub GetFileSize(iSize As Long) As String
  
  If iSize < 1000 Then
    Return Subst("&1 B", CStr(iSize))
  Else If iSize < 1000000 Then
    Return Subst("&1 KiB", Format(iSize / 1000, "#.#"))
  Else If iSize < 1000000000 Then
    Return Subst("&1 MiB", Format(iSize / 1000000, "#.#"))
  Else
    Return Subst("&1 GiB", Format(iSize / 1000000000, "#.#"))
  Endif
  
End

Private Sub RefreshView()

  Dim sFile As String
  Dim sDir As String
  Dim hPictFile As Picture
  Dim hPictFolder As Picture
  Dim hPict As Picture
  Dim sPrefix As String
  Dim iSize As Integer

  Inc Application.Busy

  If $hColumnView.Visible Then
    $hColumnView.Clear
    hPictFile = Picture["icon:/small/file"]
    hPictFolder = Picture["icon:/small/directory"]
    iSize = 16
  Else
    $hIconView.Clear
    hPictFile = Picture["icon:/32/file"]
    hPictFolder = Picture["icon:/32/directory"]
    iSize = 32
  Endif

  sDir = $sDir
  If Not sDir Then sDir = User.Home

  For Each sFile In Dir(sDir, "*").Sort()
    If Not $bShowHidden And If Left(sFile) = "." Or Right(sFile) = "~" Then Continue
    With Stat(sDir &/ sFile)
      If .Type = gb.Directory Then
        If Not $bShowDir Then Continue
        sPrefix = "0"
      Else
        If $aFilter And If CheckFilter(sFile) Then Continue
        sPrefix = "1"
      Endif
      hPict = GetIcon(sDir &/ sFile, iSize)
      If Not hPict Then 
        If .Type = gb.Directory Then 
          hPict = hPictFolder
        Else 
          hPict = hPictFile
        Endif
      Endif
      If $hColumnView.Visible Then
        $hColumnView.Add(sPrefix & sFile, sFile, hPict)
        $hColumnView[sPrefix & sFile][1] = "  " & GetFileSize(.Size)
        $hColumnView[sPrefix & sFile][2] = "  " & Str(.Time)
      Else
        $hIconView.Add(sPrefix & sFile, sFile, hPict)
      Endif
    End With
  Next

Finally

  Dec Application.Busy
  
Catch 

  Debug Error.Where; ": "; Error.Text 

End

Private Sub RefreshViewLater()
  
  If $bRefreshTriggered Then Return
  
  $bRefreshTriggered = True
  $hRefresh.Trigger
  
End

Public Sub Refresh_Timer()
  
  $bRefreshTriggered = False
  RefreshView
  
End



Public Sub Reload()
  
  RefreshView
  
End


Private Sub RefreshGrid()

End


Private Function Dir_Read() As String

  Return $sDir

End

Private Sub Dir_Write(sDir As String)

  $sDir = sDir
  RefreshViewLater

End

Private Function ShowHidden_Read() As Boolean

  Return $bShowHidden

End

Private Sub ShowHidden_Write(bShowHidden As Boolean)

  If bShowHidden = $bShowHidden Then Return 
  $bShowHidden = bShowHidden
  RefreshViewLater

End

Private Function ShowDirectory_Read() As Boolean

  Return $bShowDir

End

Private Sub ShowDirectory_Write(bShow As Boolean)

  $bShowDir = bShow
  RefreshViewLater

End

Private Function GetView() As Object

  If $hIconView.Visible Then
    Return $hIconView
  Else
    Return $hColumnView
  Endif

End


Private Function Current_Read() As String

  Try Return Mid$(GetView().Current.Key, 2)

End


Private Sub Current_Write(sFile As String)

  Dim sKey As String

  GetView().SelectAll(False)
  sKey = "0" & sFile
  If Not GetView().Exist(sKey) Then sKey = "1" & sFile
  If Not GetView().Exist(sKey) Then Return
    
  GetView()[sKey].Selected = True
  GetView()[sKey].EnsureVisible

End

Private Function Font_Read() As Font

  Return Super.Font

End

Private Sub Font_Write(hFont As Font)

  Super.Font = hFont
  RefreshGrid

End

Private Function ShowDetailed_Read() As Boolean

  Return $hColumnView.Visible

End

Private Sub ShowDetailed_Write(bDetailed As Boolean)

  If bDetailed = ShowDetailed_Read() Then Return

  If bDetailed Then

    $hColumnView.Show
    $hIconView.Hide

  Else

    $hIconView.Show
    $hColumnView.Hide

  Endif
  
  RefreshViewLater
  TakeSelection

End


Public Sub View_Select()

  Raise {Select}

End

Public Sub View_Click()

  Raise Click

End

Public Sub View_Activate()

  Raise Activate

End


Public Sub View_Menu()

  Raise Menu

End


Public Sub View_Compare(Key As String, OtherKey As String)

  Dim hStat As Stat
  Dim hStat2 As Stat
  Dim sDir As String
  Dim iComp As Integer

  sDir = $sDir
  If Not sDir Then sDir = User.Home

  If $hColumnView.Visible Then
    $iSort = $hColumnView.Columns.Sort
    $bAsc = $hColumnView.Columns.Ascending
  Else 
    $hIconView.Ascending = $bAsc
  Endif

  iComp = Comp(Asc(Key), Asc(OtherKey))

  If iComp = 0 Then

    If $iSort Then
      hStat = Stat(sDir &/ Mid$(Key, 2))
      hStat2 = Stat(sDir &/ Mid$(OtherKey, 2))
    Endif

    Select $iSort

      Case 1
        iComp = Sgn(hStat.Size - hStat2.Size)

      Case 2
        iComp = Sgn(hStat.Time - hStat2.Time)

    End Select

    If iComp = 0 Then iComp = Comp(Key, OtherKey, gb.IgnoreCase + gb.Natural)

    'IF NOT $bAsc THEN iComp = (- iComp)

  Endif

  Last.Compare = iComp

Catch

End

Private Sub Mode_Write(iMode As Integer)

  $hIconView.Mode = iMode
  $hColumnView.Mode = iMode

End

Private Function Mode_Read() As Integer

  Return $hIconView.Mode

End

Private Function Selection_Read() As String[]

  Dim hView As Object
  Dim aSel As New String[]

  If $hIconView.Visible Then
    hView = $hIconView
  Else
    hView = $hColumnView
  Endif

  hView.MoveFirst
  While hView.Available
    If hView.Item.Selected Then
      aSel.Add(hView.Item.Text)
    Endif
    hView.MoveNext
  Wend

  Return aSel

End

Private Sub TakeSelection()

  Dim hSrc As Object
  Dim hDst As Object

  If $hIconView.Mode = Select.None Then Return

  hSrc = $hIconView
  hDst = $hColumnView
  If $hIconView.Visible Then Swap hSrc, hDst

  If $hIconView.Mode = Select.Single Then
    If hSrc.Current And If hSrc.Current.Selected Then
      Try hDst[hSrc.Key].Selected = True
    Endif
    Return
  Endif

  hDst.SelectAll(False)
  hSrc.MoveFirst
  While hSrc.Available
    If hSrc.Item.Selected Then
      Object.Lock(hDst)
      hDst[hSrc.Item.Key].Selected = True
      Object.Unlock(hDst)
    Endif
    hSrc.MoveNext
  Wend

End

Private Function Filter_Read() As String[]

  Return $aFilter

End

Private Sub Filter_Write(aFilter As String[])

  $aFilter = aFilter
  RefreshViewLater

End

Private Function Icon_Read() As Picture

  Return $hPict  

End

Private Sub Icon_Write(Value As Picture)

  $hPict = Value

End

Private Function Border_Read() As Boolean

  Return $hColumnView.Border

End

Private Sub Border_Write(Value As Boolean)

  $hColumnView.Border = Value
  $hIconView.Border = Value

End

Private Function Settings_Read() As Variant[]

  Return [CVariant(ShowDetailed_Read()), ShowHidden_Read(), $hColumnView.Settings]

  'Return IIf(ShowDetailed_Read(), "1", "0") & "," & IIf(ShowHidden_Read(), "1", "0") & "," & $hColumnView.Settings

End

Private Sub Settings_Write(Value As Variant[])

  ShowDetailed_Write(Value[0])
  ShowHidden_Write(Value[1])
  $hColumnView.Settings = Value[2]
  
Catch

  Debug Error.Where; ": "; Error.Text

End

Private Function Count_Read() As Integer

  If $hIconView.Visible Then 
    Return $hIconView.Count
  Else 
    Return $hColumnView.Count
  Endif    

End

' PUBLIC SUB View_MouseMove()
'   
'   IF $hIconView.Visible THEN RETURN 
'   
'   IF $hColumnView.Find(Mouse.X, Mouse.Y) THEN RETURN 
'   DEBUG $hColumnView.Item.Text
'   
' END
