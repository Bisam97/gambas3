' Gambas class file

Export
Inherits UserContainer

Public Const _Properties As String = "*,Count{Range:1;256}=1,Index,Text,Picture,ShowTitle=True,ShowIndex=False,Border=True"
Public Const _DefaultEvent As String = "Change"

Event BeforeChange
Event Change
Event Cancel
Event Click
Event {Close}

Property Count As Integer
Property Index As Integer
Property Read LastIndex As Integer
Property Text As String
Property Picture As Picture
Property ShowTitle As Boolean
Property ShowIndex As Boolean
Property Border As Boolean

Private $hWizard As FWizard
Private $aStep As New Object[]
Private $iCurrent As Integer = -1
Private $iLast As Integer = -1
Private $bShowIndex As Boolean

Public Sub _new()

  $hWizard = New FWizard(Me)
  Object.Attach($hWizard, Me, "Wizard")

  Me.Count = 1
  'ME.Index = 0

End

Private Function Count_Read() As Integer

  Return $aStep.Count

End

Private Sub Count_Write(iCount As Integer)

  Dim iInd As Integer
  Dim hStep As WizardContainer

  If iCount < 1 Then Error.Raise("Bad argument")
  If iCount = $aStep.Count Then Return

  If iCount < $aStep.Count Then

    For iInd = $aStep.Max To iCount Step -1
      hStep = $aStep[iInd]
      If hStep.Children.Count Then Error.Raise("Wizard step is not empty")
    Next

    For iInd = $aStep.Max To iCount Step -1
      $aStep[iInd].Delete
    Next

    $aStep.Remove(iCount, -1)
    Index_Write(Min($iCurrent, $aStep.Max))

  Else

    For iInd = $aStep.Count To iCount - 1
      hStep = New WizardContainer($hWizard.GetContainer()) As "WizardContainer"
      hStep.Tag = iInd
      $aStep.Add(hStep)
      hStep.Text = Subst(("Step #&1"), CInt(iInd + 1))
    Next
    'ME.Index = iCount - 1
    Index_Write(0)

  Endif

End

Private Sub GetNext(iInd As Integer) As Integer
  
  Do
    Inc iInd
    If iInd >= $aStep.Count Then Return -1
    If $aStep[iInd].Enabled Then Return iInd
  Loop
  
End

Private Sub GetPrevious(iInd As Integer) As Integer
  
  Do
    Dec iInd
    If iInd < 0 Then Return -1
    If $aStep[iInd].Enabled Then Return iInd
  Loop
  
End


Private Function Index_Read() As Integer

  Return $iCurrent

End

Private Sub Index_Write(iIndex As Integer)

  Dim bCancel As Boolean
  Dim bWasNext As Boolean

  If iIndex < 0 Or iIndex >= $aStep.Count Then Error.Raise("Bad index")

  If iIndex = $iCurrent Then Return
  
  If Not $aStep[iIndex].Enabled Then Return

  If iIndex > $iCurrent Then
  
    bWasNext = iIndex = GetNext($iCurrent)
    
    bCancel = Raise BeforeChange
    If bCancel Then Return
    
    If bWasNext Then
      iIndex = GetNext($iCurrent)
      If iIndex < 0 Then Return
    Endif
  
  Endif

  Me._Container = $aStep[iIndex]

  $iLast = $iCurrent
  $iCurrent = iIndex

  RefreshWizard

  Raise Change
  Raise Click

End

Private Sub GetEnabledIndex(iCurrent As Integer) As Integer
  
  Dim iCount As Integer
  Dim iIndex As Integer
  
  iIndex = -1
  Do
    iIndex = GetNext(iIndex)
    If iIndex > iCurrent Then Return
    Inc iCount
    If iIndex = iCurrent Then Return iCount
  Loop
  
End


Private Sub RefreshWizard()

  Dim hCurrent As WizardContainer
  Dim iIndex As Integer
  Dim sText As String

  If $iCurrent >= 0 Then

    hCurrent = $aStep[$iCurrent]
    hCurrent.Show
    hCurrent.Raise
    
    sText = hCurrent.Text
    If $bShowIndex Then
      iIndex = GetEnabledIndex($iCurrent)
      If iIndex Then sText = CStr(iIndex) & ". " & sText
    Endif
    $hWizard.SetTitle(sText, hCurrent.Picture)
    $hWizard.SetPosition($iCurrent, GetPrevious($iCurrent) >= 0, GetNext($iCurrent) >= 0)
   
    Wait

  Endif

  If $iLast >= 0 And $iLast <= $aStep.Max Then
    $aStep[$iLast].Lower
    $aStep[$iLast].Hide
  Endif

End


Private Function Text_Read() As String

  Return $aStep[$iCurrent].Text

End

Private Sub Text_Write(sText As String)

  $aStep[$iCurrent].Text = sText

End

Private Function Picture_Read() As Picture

  Return $aStep[$iCurrent].Picture

End

Private Sub Picture_Write(hPict As Picture)

  $aStep[$iCurrent].Picture = hPict

End

Public Sub WizardContainer_Refresh()

  RefreshWizard

End

Public Function _get(Index As Integer) As WizardContainer

  If Index < 0 Or Index >= $aStep.Count Then Error.Raise("Bad index")
  Return $aStep[Index]

End

Public Sub Wizard_Previous()

  Dim iInd As Integer = GetPrevious($iCurrent)
  If iInd >= 0 Then Index_Write(iInd)

End

Public Sub Wizard_Next()

  Dim iInd As Integer = GetNext($iCurrent)
  If iInd >= 0 Then
    Index_Write(iInd)
  Else
    Raise BeforeChange
    Raise {Close}
  Endif

End

Public Sub Wizard_Cancel()

  Raise Cancel

End

Private Function ShowTitle_Read() As Boolean

  Return $hWizard.GetShowTitle()

End

Private Sub ShowTitle_Write(Value As Boolean)

  $hWizard.SetShowTitle(Value)

End

Private Function Border_Read() As Boolean

  Return $hWizard.GetBorder()

End

Private Sub Border_Write(Value As Boolean)

  $hWizard.SetBorder(Value)

End

Private Function LastIndex_Read() As Integer

  Return $iLast  

End

Private Function ShowIndex_Read() As Boolean

  Return $bShowIndex

End

Private Sub ShowIndex_Write(Value As Boolean)

  $bShowIndex = Value
  RefreshWizard

End
