' Gambas class file

Public Name As String
Public Mime As String
Public Data As String
Public NameSet As Boolean
Public Encoding As Integer
Public Parent As Integer
Public Boundary As String
Public Charset As String

Public Sub _new(Optional sMime As String, Optional sName As String)
  
  Mime = sMime
  Name = sName
  
  CheckMime
  
End


Private Sub CheckMime()
  
  Dim iPos As Integer
  Dim sCharset As String
  
  ' static int decode_mime(char *mime)
  ' {
  '   char *p, *p2;
  ' 
  '   GB.FreeString(&_mime_type);
  '   GB.FreeString(&_mime_subtype);
  '   GB.FreeString(&_mime_charset);
  '   
  '   _mime_charset = GB.NewZeroString(GB.System.Charset());
  '   
  '   if (!mime || !*mime)
  '   {
  '     _mime_type = GB.NewZeroString("text");
  '     _mime_subtype = GB.NewZeroString("plain");
  '     _mime_encoding = LIBSMTP_ENC_QUOTED;
  '     return FALSE;
  '   }
  
  If Not Mime Then
    Mime = "text/plain;charset=" & System.Charset
    Encoding = Encode.ENC_QUOTED
    Return
  Endif
  
  ' 
  '   p = mime;
  '   p2 = index(p, '/');
  '   if (!p2)
  '   {
  '     GB.Error("Cannot find MIME subtype");
  '     return TRUE;
  '   }
  ' 
  '   _mime_type = GB.NewString(p, p2 - p);
  ' 
  '   p = p2 + 1;
  '   p2 = index(p, ';');
  '   if (p2)
  '   {
  '     _mime_subtype = GB.NewString(p, p2 - p);
  '     
  '     p = p2 + 1;
  '     if (strncasecmp(p, "CHARSET=", 8))
  '     {
  '       GB.Error("Syntax error in MIME charset");
  '       return TRUE;
  '     }
  '     p += 8;
  '     GB.FreeString(&_mime_charset);
  '     _mime_charset = GB.NewString(p, &mime[strlen(mime)] - p);
  '   }
  '   else
  '   {
  '     _mime_subtype = GB.NewString(p, &mime[strlen(mime)] - p);
  '   }
  ' 
  
  iPos = RInStr(Mime, ";")
  If iPos Then
    If Left(Mime, iPos - 1) Not Like "*/*" Then Goto SYNTAX_ERROR
    sCharset = Trim(Mid$(Mime, iPos + 1))
    If sCharset Not Begins "charset=" Then Goto SYNTAX_ERROR
    Charset = Trim(Mid$(sCharset, 9))
  Else
    If Mime Not Like "*/*" Then Goto SYNTAX_ERROR
  Endif
  
  
  '   if (!strcmp(_mime_type, "text") || !strcmp(_mime_type, "message"))
  '   {
  '     _mime_encoding = LIBSMTP_ENC_QUOTED;
  '   }
  '   else
  '   {
  '     if (!strcmp(_mime_type, "multipart"))
  '       _mime_encoding = LIBSMTP_ENC_7BIT;
  '     else
  '       _mime_encoding = LIBSMTP_ENC_BASE64;
  '   }
  ' 
  '   return FALSE;
  ' }
  ' 
  If Mime Begins "text/" Or If Mime Begins "message/" Then
    Encoding = Encode.ENC_QUOTED
  Else If Mime Begins "multipart/" Then
    Encoding = Encode.ENC_7BITS
  Else
    Encoding = Encode.ENC_BASE64
  Endif
  
  Return
  
SYNTAX_ERROR:

  Error.Raise("Incorrect mime type")
  
End

Public Sub SetBoundary(hSession As SmtpSession)
  
  ' void libsmtp_set_boundary(struct libsmtp_part_struct *part, int index)
  ' {
  '   static char pattern[33];
  '   static char digits[] = "0123456789ABCDEF";
  '   int i;
  '   
  '   for(i = 0; i < 32; i++)
  '     pattern[i] = digits[(random() >> 4) & 0xF];
  '   
  '   pattern[32] = 0;
  ' 
  '   g_string_sprintf(part->Boundary, "----%s%02d", pattern, index);
  ' }
  ' 
  
  Dim sBoundary As String
  Dim I As Integer
  Dim sDigit As String = "0123456789ABCDEF"
  
  For I = 1 To 32 - SizeOf(gb.Pointer) * 2
    sBoundary &= Mid$(sDigit, Int(Rnd(16)) + 1, 1)
  Next
  
  Inc hSession._Count
  Boundary = sBoundary & Hex$(hSession._Count, 2)
  
End

Public Sub SendHeaders(hSession As SmtpSession)
  
  Dim sHeader As String
  
  sHeader = "Content-Type: " & Mime
  
  If Name Then sHeader &= "; name=\"" & Name & "\""
  
  If Mime Begins "text/" Or If Mime Begins "message/" Then
   If Charset Then
     sHeader &= "; charset=\"" & Charset & "\""
   Endif
  Endif

  If Mime Begins "multipart/" Then
    SetBoundary(hSession)
    sHeader &= "; boundary=\"" & Boundary & "\""
  Endif

  hSession.Print(sHeader)
  
  If Mime Not Begins "multipart/" Then hSession.Print("Content-Transfer-Encoding: " & Encode.Format(Encoding))
  
  hSession.Print("Content-Length: " & Len(Data))
  
  hSession.Print
  
End


Public Sub Send(hSession As SmtpSession)
  
  Select Case Encoding
    Case Encode.ENC_QUOTED
      Encode.PrintQuoted(hSession.Stream, Data, hSession._Debug)
    Case Encode.ENC_BASE64
      Encode.PrintBase64(hSession.Stream, Data, hSession._Debug)
    Case Else
      hSession.Print(Data)
  End Select
  hSession.Print
  
End
