' Gambas class file

Export
Create Static

Class _Keyring

Private $bOpen As Boolean
Private $sKDEWalletId As String

Private Sub OpenWallet()
  
  Dim sResult As String
  Dim sWallet As String
  
  If $bOpen Then Return
  
  Select Case Desktop.Type
  
    Case "KDE"
    
      Shell "dcop kded kwalletd localWallet" To sResult
      sWallet = Trim(Split(sResult, "\n")[0])
      Shell Subst("dcop kded kwalletd open &1 0", sWallet) To sResult
      $sKDEWalletId = Trim(sResult)
    
    Case "GNOME"
    
      Components.Load("gb.desktop.gnome")
    
    Default
      Error.Raise("Don't know how to store passwords on desktop " & Desktop.Type)
  
  End Select
  
End


Public Sub _get(Key As String) As String
  
  Dim sResult As String
  
  OpenWallet
  
  Select Case Desktop.Type
  
    Case "KDE"
    
      Shell Subst("dcop kded kwalletd readPassword &1 &2 &3", $sKDEWalletId, Shell$(Application.Name), Shell$(Key)) To sResult
      sResult = Replace(sResult, "\n", "")
      Return sResult

    Case "GNOME"
    
      Return _Keyring.GetPassword(Key)
  
  End Select
  
End

Public Sub _put(Value As String, Key As String)
  
  OpenWallet
  
  Select Case Desktop.Type
  
    Case "KDE"
    
      Shell Subst("dcop kded kwalletd writePassword &1 &2 &3 &4", $sKDEWalletId, Shell$(Application.Name), Shell$(Key), Shell$(Value)) Wait

    Case "GNOME"
    
      _Keyring.SetPassword(Key, Value)
  
  End Select
  
End
